<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRUD DOM</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-lg p-8">
        <h1 class="text-3xl font-bold text-center text-blue-400 mb-8">Bài Tập CRUD DOM: Quản Lý Sản Phẩm</h1>
        
        <div class="mb-8 bg-gray-50 p-6 rounded-lg">
            <h2 class="text-xl font-semibold text-blue-400 mb-4">Thêm Sản phẩm Mới</h2>
            <input type="text" id="productName" placeholder="Tên Sản phẩm" 
                   class="w-full mb-4 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
            <input type="text" id="productPrice" placeholder="Giá (VND)" 
                   class="w-full mb-4 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
            <button id="addBtn" class="bg-blue-400 hover:bg-blue-500 text-white font-semibold px-6 py-2 rounded-lg">
                Thêm Sản phẩm
            </button>
        </div>

        <div>
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Danh sách Sản phẩm</h2>
            <table class="w-full border-collapse">
                <thead>
                    <tr class="bg-blue-400 text-white">
                        <th class="p-3 text-left">ID</th>
                        <th class="p-3 text-left">Tên Sản phẩm</th>
                        <th class="p-3 text-left">Giá</th>
                        <th class="p-3 text-left">Thao tác</th>
                    </tr>
                </thead>
                <tbody id="productList">
                    <tr class="border-b hover:bg-gray-50">
                        <td class="p-3">1</td>
                        <td class="p-3">Bàn phím cơ</td>
                        <td class="p-3">1.200.000</td>
                        <td class="p-3">
                            <button class="updateBtn bg-yellow-400 hover:bg-yellow-500 text-white font-semibold px-4 py-1 rounded mr-2">Sửa</button>
                            <button class="deleteBtn bg-red-500 hover:bg-red-600 text-white font-semibold px-4 py-1 rounded">Xóa</button>
                        </td>
                    </tr>
                    <tr class="border-b hover:bg-gray-50">
                        <td class="p-3">2</td>
                        <td class="p-3">Máy tính bàn</td>
                        <td class="p-3">15.000.000</td>
                        <td class="p-3">
                            <button class="updateBtn bg-yellow-400 hover:bg-yellow-500 text-white font-semibold px-4 py-1 rounded mr-2">Sửa</button>
                            <button class="deleteBtn bg-red-500 hover:bg-red-600 text-white font-semibold px-4 py-1 rounded">Xóa</button>
                        </td>
                    </tr>
                    <tr class="border-b hover:bg-gray-50">
                        <td class="p-3">3</td>
                        <td class="p-3">Laptop cơ bản</td>
                        <td class="p-3">22.000.000</td>
                        <td class="p-3">
                            <button class="updateBtn bg-yellow-400 hover:bg-yellow-500 text-white font-semibold px-4 py-1 rounded mr-2">Sửa</button>
                            <button class="deleteBtn bg-red-500 hover:bg-red-600 text-white font-semibold px-4 py-1 rounded">Xóa</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let currentId = 4;
        let editingRow = null;

        function getProductsFromTable() {
            const rows = Array.from(document.getElementById('productList').rows);
            return rows.map(row => ({
                id: Number(row.cells[0].textContent),
                name: row.cells[1].textContent,
                price: row.cells[2].textContent
            }));
        }

        function saveToLocalStorage() {
            try {
                const products = getProductsFromTable();
                localStorage.setItem('products', JSON.stringify(products));
            } catch (e) {
                console.error(e);
            }
        }

        function loadFromLocalStorage() {
            const raw = localStorage.getItem('products');
            if (!raw) {
                alert('Không có dữ liệu trong localStorage.');
                return;
            }
            try {
                const products = JSON.parse(raw);
                const productList = document.getElementById('productList');
                productList.innerHTML = '';
                products.forEach(p => {
                    const newRow = document.createElement('tr');
                    newRow.className = 'border-b hover:bg-gray-50';
                    newRow.innerHTML = `
                        <td class="p-3">${p.id}</td>
                        <td class="p-3">${p.name}</td>
                        <td class="p-3">${p.price}</td>
                        <td class="p-3">
                            <button class="updateBtn bg-yellow-400 hover:bg-yellow-500 text-white font-semibold px-4 py-1 rounded mr-2">Sửa</button>
                            <button class="deleteBtn bg-red-500 hover:bg-red-600 text-white font-semibold px-4 py-1 rounded">Xóa</button>
                        </td>
                    `;
                    productList.appendChild(newRow);
                });
                currentId = products.length > 0 ? Math.max(...products.map(p => p.id)) + 1 : 1;
            } catch (e) {
                console.error(e);
                alert('Không thể đọc dữ liệu từ localStorage (đã bị hỏng).');
            }
        }

        function clearLocalStorage() {
            if (confirm('Bạn có chắc muốn xóa dữ liệu đã lưu trong localStorage?')) {
                localStorage.removeItem('products');
                alert('Đã xóa dữ liệu localStorage.');
            }
        }

        function saveIfAuto() {
            const auto = document.getElementById('autoSave')?.checked ?? true;
            if (auto) saveToLocalStorage();
        }

        function addProduct() {
            const name = document.getElementById('productName').value.trim();
            const price = document.getElementById('productPrice').value.trim();
            
            if (!name || !price) {
                alert('Vui lòng nhập đầy đủ thông tin!');
                return;
            }

            const productList = document.getElementById('productList');
            const newRow = document.createElement('tr');
            newRow.className = 'border-b hover:bg-gray-50';
            newRow.innerHTML = `
                <td class="p-3">${currentId}</td>
                <td class="p-3">${name}</td>
                <td class="p-3">${price}</td>
                <td class="p-3">
                    <button class="updateBtn bg-yellow-400 hover:bg-yellow-500 text-white font-semibold px-4 py-1 rounded mr-2">Sửa</button>
                    <button class="deleteBtn bg-red-500 hover:bg-red-600 text-white font-semibold px-4 py-1 rounded">Xóa</button>
                </td>
            `;
            
            productList.appendChild(newRow);
            currentId++;
            
            document.getElementById('productName').value = '';
            document.getElementById('productPrice').value = '';

            saveIfAuto();
        }

        function deleteProduct(event) {
            const row = event.target.closest('tr');
            if (confirm('Bạn có chắc muốn xóa sản phẩm này?')) {
                row.remove();
                saveIfAuto();
            }
        }

        function updateProduct(event) {
            const row = event.target.closest('tr');
            const cells = row.cells;
            
            if (editingRow && editingRow !== row) {
                alert('Vui lòng hoàn tất chỉnh sửa sản phẩm hiện tại trước!');
                return;
            }
            
            if (!editingRow) {
                const name = cells[1].textContent;
                const price = cells[2].textContent;
                
                cells[1].innerHTML = `<input type="text" value="${name}" class="w-full p-1 border rounded">`;
                cells[2].innerHTML = `<input type="text" value="${price}" class="w-full p-1 border rounded">`;
                
                event.target.textContent = 'Lưu';
                event.target.classList.remove('bg-yellow-400', 'hover:bg-yellow-500');
                event.target.classList.add('bg-green-500', 'hover:bg-green-600');
                
                editingRow = row;
            } else {
                const nameInput = cells[1].querySelector('input');
                const priceInput = cells[2].querySelector('input');
                
                const newName = nameInput.value.trim();
                const newPrice = priceInput.value.trim();
                
                if (!newName || !newPrice) {
                    alert('Vui lòng nhập đầy đủ thông tin!');
                    return;
                }
                
                cells[1].textContent = newName;
                cells[2].textContent = newPrice;
                
                event.target.textContent = 'Sửa';
                event.target.classList.remove('bg-green-500', 'hover:bg-green-600');
                event.target.classList.add('bg-yellow-400', 'hover:bg-yellow-500');
                
                editingRow = null;

                saveIfAuto();
            }
        }

        document.getElementById('addBtn').addEventListener('click', addProduct);
        
        document.getElementById('productList').addEventListener('click', function(event) {
            if (event.target.classList.contains('deleteBtn')) {
                deleteProduct(event);
            } else if (event.target.classList.contains('updateBtn')) {
                updateProduct(event);
            }
        });

        (function attachStorageControls() {
            const controlsHtml = `
                <div class="mb-6 flex items-center gap-3">
                    <label class="flex items-center gap-2 text-sm">
                        <input type="checkbox" id="autoSave" checked class="form-checkbox">
                        <span>Lưu tự động vào localStorage</span>
                    </label>
                    <button id="saveToLSBtn" class="bg-blue-400 hover:bg-blue-500 text-white font-semibold px-4 py-1 rounded">Lưu ngay</button>
                    <button id="loadFromLSBtn" class="bg-green-400 hover:bg-green-500 text-white font-semibold px-4 py-1 rounded">Tải</button>
                    <button id="clearLSBtn" class="bg-red-500 hover:bg-red-600 text-white font-semibold px-4 py-1 rounded">Xóa lưu</button>
                </div>
            `;
            const formContainer = document.querySelector('.mb-8.bg-gray-50.p-6.rounded-lg');
            if (formContainer) formContainer.insertAdjacentHTML('beforeend', controlsHtml);

            document.getElementById('saveToLSBtn').addEventListener('click', function() {
                saveToLocalStorage();
                alert('Đã lưu dữ liệu vào localStorage.');
            });

            document.getElementById('loadFromLSBtn').addEventListener('click', function() {
                loadFromLocalStorage();
            });

            document.getElementById('clearLSBtn').addEventListener('click', function() {
                clearLocalStorage();
            });
        })();

        if (localStorage.getItem('products')) {
            loadFromLocalStorage();
        }
    </script>
</body>
</html>