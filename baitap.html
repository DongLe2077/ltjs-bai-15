<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRUD DOM - json-server</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-lg p-8">
        <h1 class="text-3xl font-bold text-center text-blue-400 mb-8">Bài Tập CRUD DOM: Quản Lý Sản Phẩm (json-server)</h1>
        
        <!-- Form Thêm Sản Phẩm -->
        <div class="mb-8 bg-gray-50 p-6 rounded-lg">
            <h2 class="text-xl font-semibold text-blue-400 mb-4">Thêm Sản phẩm Mới</h2>
            <input type="text" id="productName" placeholder="Tên Sản phẩm" 
                   class="w-full mb-4 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
            <input type="text" id="productPrice" placeholder="Giá (VND)" 
                   class="w-full mb-4 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
            <button id="addBtn" class="bg-blue-400 hover:bg-blue-500 text-white font-semibold px-6 py-2 rounded-lg">
                Thêm Sản phẩm
            </button>
        </div>

        <!-- Bảng Danh Sách Sản Phẩm -->
        <div>
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Danh sách Sản phẩm</h2>
            <table class="w-full border-collapse">
                <thead>
                    <tr class="bg-blue-400 text-white">
                        <th class="p-3 text-left">ID</th>
                        <th class="p-3 text-left">Tên Sản phẩm</th>
                        <th class="p-3 text-left">Giá</th>
                        <th class="p-3 text-left">Thao tác</th>
                    </tr>
                </thead>
                <tbody id="productList">
                    <!-- rows rendered from json-server -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000/posts';

        // Lấy dữ liệu từ server và render
        async function fetchAndRender() {
            try {
                const res = await fetch(API_BASE);
                const data = await res.json();
                const productList = document.getElementById('productList');
                productList.innerHTML = '';
                data.forEach(renderProductRow);
            } catch (err) {
                console.error('Lỗi khi lấy dữ liệu:', err);
                alert('Không thể kết nối tới server. Hãy chắc json-server đang chạy.');
            }
        }

        function formatPrice(num) {
            return Number(num).toLocaleString('vi-VN');
        }

        function renderProductRow(product) {
            const productList = document.getElementById('productList');
            const tr = document.createElement('tr');
            tr.className = 'border-b hover:bg-gray-50';
            tr.dataset.id = product.id;
            tr.innerHTML = `
                <td class="p-3">${product.id}</td>
                <td class="p-3">${product.name}</td>
                <td class="p-3">${formatPrice(product.price)}</td>
                <td class="p-3">
                    <button class="updateBtn bg-yellow-400 hover:bg-yellow-500 text-white font-semibold px-4 py-1 rounded mr-2">Sửa</button>
                    <button class="deleteBtn bg-red-500 hover:bg-red-600 text-white font-semibold px-4 py-1 rounded">Xóa</button>
                </td>
            `;
            productList.appendChild(tr);
        }

        // Thêm sản phẩm (POST)
        async function addProduct() {
            const nameEl = document.getElementById('productName');
            const priceEl = document.getElementById('productPrice');
            const name = nameEl.value.trim();
            const price = priceEl.value.trim();

            if (!name || !price) { alert('Vui lòng nhập đầy đủ thông tin!'); return; }

            try {
                const res = await fetch(API_BASE, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, price: Number(price) })
                });
                const created = await res.json();
                renderProductRow(created);
                nameEl.value = '';
                priceEl.value = '';
            } catch (err) {
                console.error('Lỗi khi thêm:', err);
                alert('Thêm sản phẩm thất bại. Kiểm tra server.');
            }
        }

        // Xóa sản phẩm (DELETE)
        async function deleteProduct(event) {
            const row = event.target.closest('tr');
            const id = row.dataset.id;
            if (!id) return;
            if (!confirm('Bạn có chắc muốn xóa sản phẩm này?')) return;
            try {
                await fetch(`${API_BASE}/${id}`, { method: 'DELETE' });
                row.remove();
            } catch (err) {
                console.error('Lỗi khi xóa:', err);
                alert('Xóa thất bại. Kiểm tra server.');
            }
        }

        // Sửa sản phẩm (PUT)
        async function updateProduct(event) {
            const btn = event.target;
            const row = btn.closest('tr');
            const id = row.dataset.id;
            const cells = row.cells;

            // Nếu đang ở chế độ edit (button text là 'Lưu')
            if (btn.textContent === 'Lưu') {
                const nameInput = cells[1].querySelector('input');
                const priceInput = cells[2].querySelector('input');
                const newName = nameInput.value.trim();
                const newPrice = priceInput.value.trim();
                if (!newName || !newPrice) { alert('Vui lòng nhập đầy đủ thông tin!'); return; }
                try {
                    const res = await fetch(`${API_BASE}/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id: Number(id), name: newName, price: Number(newPrice) })
                    });
                    const updated = await res.json();
                    cells[1].textContent = updated.name;
                    cells[2].textContent = formatPrice(updated.price);
                    btn.textContent = 'Sửa';
                    btn.classList.remove('bg-green-500','hover:bg-green-600');
                    btn.classList.add('bg-yellow-400','hover:bg-yellow-500');
                } catch (err) {
                    console.error('Lỗi khi cập nhật:', err);
                    alert('Cập nhật thất bại. Kiểm tra server.');
                }
            } else {
                // Chuyển sang chế độ edit
                const name = cells[1].textContent;
                const price = cells[2].textContent.replace(/\./g, '').trim();
                cells[1].innerHTML = `<input type="text" value="${name}" class="w-full p-1 border rounded">`;
                cells[2].innerHTML = `<input type="text" value="${price}" class="w-full p-1 border rounded">`;
                btn.textContent = 'Lưu';
                btn.classList.remove('bg-yellow-400','hover:bg-yellow-500');
                btn.classList.add('bg-green-500','hover:bg-green-600');
            }
        }

        document.getElementById('addBtn').addEventListener('click', addProduct);
        document.getElementById('productList').addEventListener('click', function(event) {
            if (event.target.classList.contains('deleteBtn')) deleteProduct(event);
            else if (event.target.classList.contains('updateBtn')) updateProduct(event);
        });

        // Load dữ liệu ban đầu
        document.addEventListener('DOMContentLoaded', fetchAndRender);
    </script>
</body>
</html>